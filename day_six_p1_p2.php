<?php

$startTime = time();

echo "start time: $startTime \n\n";

$map = "
............#.............#......................#....#....................................................#..............#.......
..................................#...#......#.......#........#..................#....#...........................##....#.........
...........#...........#...........#...#...#...............................#.......................##....................#........
..................#.............#........#.....................#...........................................................#......
....#............................................................#..#...#......#.#......#...#..........#..#.....#....#...#........
.................................#......##.............................#..........................#...#.........#.................
.#.............#.........#..#..............................................................................##...........#..#......
....#..............#..........................##......#........#...#........#..........#........#.............#...................
.....#.......#..#......#..#..................................................................#.........................#..........
......................#...............................#......#................................#......#.....#......................
.......#.........#.....................................................................#....#.#.....................#.........#...
........................#......##..........#....#..........................#....................#...................#.........#...
................#..#............#...#.................................................................#...........#...............
.#.....#.....................#..........................................#................................#........................
.............#.##........#......#......#......................#..................................................#...#..........#.
.......#.........#.#..........#.............#.......#............#.....................#..........................................
.............................#.........................................................#.........#.........#.............#........
....#..#.#..................................................#...........#..................#....#.................................
...............#..........#.....#..............................................................#..................................
.......##.............................................................................#...............#.........#.................
....#.....#..........................#..........#................................#....................#...#.......................
.#.................................................#..#.....#.....................................................................
...........................#..............#.#...#..........................................#......#..........................#....
.#....#........#....................................................#...........................................#.................
...#..................#................##...#.............#..#....................#...............#...............................
..................................................#......#..........................................................#...#.........
#.#....................................#........#.............................................................#...................
...............................................#.......##...............................................#.........................
...#.............#................................................................................................................
.......................................#....#..#........#............#..........#.........#...#..................#................
........#.................................................#.........................................#...........#.................
...................#...........#...............................#..........................#................#..#..........#.....#..
...............#......#...............................................................#............................##..#.....##...
.........................................##.#..#..................#.......#.....................#.................................
...........#...................................................................#...#..................................#.....#.....
......#...............................#.......###..........................#....#.....................................#...........
.....##...............................#...................................................#................................#...#..
..................#....#.......#.......................................................................##.........................
.....#..#.................................................................................................#.......................
.#.................................#......................##....................................#..........................##.....
#.#................#......................................#...........................#.......#...................................
.................................#.......#.....#..............................................##..#....................#..........
............#...............................................................................#....#...........#..........#.........
................................................##...............................................#..#..........................#..
.................#.......#........................................................................#...............................
..#.........................#......#.............#.......................................#........................................
...............#.............#...........................................................#.....#..................................
.........#...............................................................................#...............................#........
.........................................#...................#.................#.........##........#.........#....................
............#..........#.....#................................................................#...##............................#.
........#...#....#..............................................#..............#........................#.........................
..#.....................................................................................................................#.........
.#....#.............................^................#..#...................#.........................#...........................
..........................................................................#.........#....#......#.................................
.........#................................#.#........................#.................#...................................#......
.............................................#.##............................................................#......#..#.........#
..........#............#...........#..#......#..........#.........................................................................
......................#....................................#....#.............##....#.............................................
......................#...#............#.......................................................................................#..
.##.................#.......................#...............#.............#......#..................................#.....#.#.....
....................#........#.......................#....................................#.......#...#.......#.......#......#....
.............................................................#.......................#..........................#.....#...........
...#.................#.......................................................#.......##...........#.......#.......................
...............##.........................#.........................................................#.....#.......#...............
.......................#.......................#.........#..............#....................#..........#........................#
...................................##..........#..........................................................#.........#.............
..................#...............................#...................................#.......#.......................#...........
.......................#..#...................................#........................#........#............#....................
...................................#....#............#..................#........................................#..........#.....
.............#...#...#......#.............##...............................................#..........................#....#......
....................#..........................................#....#......................................................#......
............#.........#...............#..#.....................................................................#.#................
.......................#..#..............................................................#.....#........#..#..................#...
.............#..#..............................#.....#.................#.............#.......................#................#...
...............#......#...........#............#.........#......................................#.................................
............................#.....#.........#.....#..#...........#................................................................
....#.......#.................#..............................................#.......#.#.............................#...#..#.....
..................................................#.#......#............................................................#.........
..................................#............#........................#.......#.........#...#...............#...................
............##....#.#......#..............................................................................#..............#........
.....#..........................................#.........................................................#........##.............
............#.....................#..#.#..............#........#......#.............................#....#...#....................
.......................#...........................................................................#..............................
......#.........................................#........#............#..#..............................#.#.......................
#.#......#..#...............#...........#....#.................................................#..................................
.........#...........#............................#..............#......................#.......................................#.
...#............#..................................#..............#............................#.........................#........
...##..#.....................................................................................#...........................#........
...............#......#.........#................................#...#............#....................#..........................
..........................#...........................#..............................................#................#....#......
.........#........#.#...........................................................................#..#..............................
.................#..............#........................................................................#.................#......
...#.........#.#.........#.#...........................................#........#........#.........#..............................
..........#............................................................#..........#.....#.........................................
..................................#.....#...........##........#......#..........#..........................#......................
...........................#....#.............#............................................................#......................
.............#.......#...................................#.....#............................................................##....
............#..............##.............#.....#...............#..........#........................#.........................#...
..##.....................................................................................................#........................
.............#.#...........#...................#....#...#......#................##................................................
.................#.#............#........................#.......##..#.........##.................................................
......................#.#...#................................................................#...............#.....#...........#..
#.................#..........................#.............................##.....#...........................................#...
..............#.........#.................#................................................................................#......
....#.#............#.......#.......................#.....#.......................#....................#.....#.............#.......
......................#..#....#.........................................#.#............##............#............................
.........#.#...#...#........................................#...............................................#....................#
.......................#...................#.............................................................#.......................#
................#............................#........#..........#.......................##....#..................................
.#...................#......................#.......................................#............................#................
..#..##.......#......#..........#..#..................................................#...........................................
..............#..........#...........................................#.........##.................................................
....#..............................#.........#...#.................#......#.#.......#.............................................
#.................................#........#.....................................#...##...................#..#...........#........
.......#.....#.............................................#..................#...................#...........#..#........#.......
.......................#................#.............#.#.........#..............................................................#
......................................................#....................#..........#................................#..........
#...............#...#.............#.................#.................................................#...........................
..................................................................#.........................#......#.........#............##......
#.................#........#.......#...#....................................#.#...................................................
.....................................#...#....#.........#................#.........................................#...#..........
............#............................#.............#.#........................................................................
......................................#.................................................#...............#.......#.................
.#.#..........#........#.......................#..................................................#....................#..........
....#...............................................................#...........#............#.......................#............
....#.......#.#..#...................#.........#..................................#....................................#..........
..............................................#...................................##.......#......................................
#...#.#............#...............................#.........#...........#..........#............................................#
..#...........#..#..........#.......................#..........##.................................................................
...#.....#..................................#................................................#....................................
";


// dierections mapping 0=up 1=right 2=down 3=left
$dx = [0,1,0,-1];
$dy = [-1,0,1,0];

// pos = key
$directionLabel = ['up', 'right', 'down', 'left'];

// guard init pos - should be variable???
$guardStartPosition = [0,0];
$guardPos = [0,0];
$direction = 0;

$lines = explode("\n", $map);

// dirty fix for map row alignment 
unset($lines[array_key_first($lines)]);
unset($lines[array_key_last($lines)]);


$lines = array_values($lines);

$maxLength = strlen($lines[0]) - 1;
$maxHeight = count($lines) - 1;

// get obstacle coordinates
$obstacleCoordinates = [];
foreach ($lines as $yPos => $line) {
    for ($xPos=0; $xPos<= $maxLength; $xPos++) {
        $char = $line[$xPos];
        if($char === '#') {
            $obstacleCoordinates[] = [$xPos, $yPos];
        } elseif($char === '^') {
            $guardStartPosition = $guardPos = [$xPos, $yPos];
        }
    }
}

// make map
$obstacleMap = [];
foreach ($obstacleCoordinates as [$ox,$oy]) {
    $obstacleMap["$ox-$oy"] = true;
}

// only distinct places
$foundExit = false;
$distinctPositions = [];
$distinctPositions[$guardPos[0].'-'.$guardPos[1]] = '';

// walking la la lalaaalaa

while (!$foundExit) {
    //var_dump($distinctPositions);
    //var_dump($maxLength);
    $newX = $guardPos[0] + $dx[$direction];
    $newY = $guardPos[1] + $dy[$direction];
    $posKey = "$newX-$newY";

    // check if out of bounds
    if ($newX < 0 || $newX > $maxLength || $newY < 0 || $newY > $maxHeight) {
        $foundExit = true;
        break;
    }

    // check obstacle
    if (isset($obstacleMap[$posKey])) {
        //var_dump($direction);
        $direction = ($direction + 1) % 4;
        //var_dump($direction);
        //exit;

        //echo "turning " . $directionLabel[$direction] . "\n";
        // redo logic
        continue;
    }

    // move
    $guardPos = [$newX, $newY];
    //echo "moving $directionLabel[$direction] \n";

    $distinctPositions[$posKey] = '';
}

echo "found exit,distinct positions: " . count($distinctPositions) . "\n\n";


// @todo should move logic to function and win/break conditions to an array per part

// part 2 check amount of loops
$totalLoops = 0;

//$i=0;
foreach($distinctPositions as $pos => $blaa) {
    //echo $i++ . "\n";
    // setup
    $direction = 0;
    $guardPos = $guardStartPosition;
    $AdjustedObstacleMap = $obstacleMap;

    // skip start pos
    if (($guardPos[0].'-'.$guardPos[1]) === $pos) {
        continue;
    }

    //echo "new round \n";
    
    [$ox,$oy] = explode('-', $pos);
    $AdjustedObstacleMap["$ox-$oy"] = true;
    
    $seenPosDir = [];
    $posDir = $guardPos[0].'-'.$guardPos[1].'-'.$direction;
    $seenPosDir[$posDir] = true;

    $foundExit = false;
    $foundLoop = false;

    while (!$foundExit && !$foundLoop) {

        // maybe limit of steps?

        $newX = $guardPos[0] + $dx[$direction];
        $newY = $guardPos[1] + $dy[$direction];
        $posKey = "$newX-$newY";

        // check out of bounds = exit
        if ($newX < 0 || $newX > $maxLength || $newY < 0 || $newY > $maxHeight) {
            //echo "found exit\n";
            $foundExit = true;
            break;
        }

        // obstacle
        if (isset($AdjustedObstacleMap[$posKey])) {

            // switch direciton
            $direction = ($direction + 1) % 4;
            //echo "turning " . $directionLabel[$direction] . "\n";
            continue;
        }

        // move
        $guardPos = [$newX, $newY];
        $posDir = "$newX-$newY-$direction";

        //var_dump($seenPosDir);
        //var_dump($posDir);
        //echo "moving $directionLabel[$direction] \n";

        // check for loop
        if (isset($seenPosDir[$posDir])) {
            $totalLoops++;
            $foundLoop = true;
        } else {
            $seenPosDir[$posDir] = true;
        }
    }
}

echo "Loops: " . $totalLoops . "\n\n";

$endTime = time();
echo "end time: $endTime \n\n";
$diff = $endTime - $startTime;
echo "duration: $diff sec\n";